# Coba NextAuth4

Create Next App dulu

```bash
npx create-next-app nextjs-coba-auth
```

## Install NextAuth

```bash
npm install next-auth
```

## Buat file [...nextauth].js

-   Buat folder `auth` di dalam folder `api`
-   Buat file `[...nextauth].js` dalam folder auth tersebut

isi dari [...nextauth].js adalah sbb:

```bash
import NextAuth from "next-auth/next";
import CredentialProvider from "next-auth/providers/credentials";

export default NextAuth({
	providers: [
		CredentialProvider({
			name: "credentials",
			credentials: {
				username: {
					label: "User Name",
					type: "text",
					placeholder: "Isi alamat Email",
				},
				password: { label: "Password", type: "password" },
			},
			authorize: (credentials) => {
				// disini nanti dimasukan pencarian ke database, untuk sementara di hardcode
				if (
					credentials.username === "admin" &&
					credentials.password === "test"
				) {
					return {
						id: 1,
						name: "Wakanda",
						email: "wakanda@gmail.com",
					};
				}

				// Jika login nya gagal
				return null;
			},
		}),
	],
	callback: {
		jwt: ({ token, user }) => {
			// first time jwt call back is run, user object is available
			if (user) {
				token.id = user.id;
			}
			return token;
		},
		session: ({ session, token }) => {
			if (token) {
				session.id = token.id;
			}
			return session;
		},
	},
	secret: "konci",
	jwt: {
		secret: "konci",
		encryption: true,
	},
});
```

Kemudian edit `_app.js` menjadi seperti di bawah ini :

```bash
import { SessionProvider } from "next-auth/react";
import "../styles/globals.css";

function MyApp({ Component, pageProps }) {
	return (
		<SessionProvider>
			<Component {...pageProps} />
		</SessionProvider>
	);
}

export default MyApp;
```

## Pembuatan folder pages/auth

Buat folder `auth` di dalam folder `pages`, kemudian buat sebuah file dengan nama `login.js` yang isinya adalah sbb :

```js
import { useRef } from "react";
import { signIn } from "next-auth/react";
import { useRouter } from "next/router";

function Login() {
	const userNameInputRef = useRef();
	const passwordInputRef = useRef();
	const router = useRouter();

	async function submitHandler(event) {
		event.preventDefault();

		const enteredUserName = userNameInputRef.current.value;
		const enteredPassword = passwordInputRef.current.value;

		console.log(enteredUserName);
		console.log(enteredPassword);
		// provider nya : credentials
		const result = await signIn("credentials", {
			redirect: false,
			username: enteredUserName,
			password: enteredPassword,
		});
		console.log(result);

		if (!result.error) {
			router.replace("/");
		} else {
			alert("user atau password salah");
		}
	}

	return (
		<section>
			<h1>Login Page</h1>
			<form onSubmit={submitHandler}>
				<div>
					<label htmlFor="username">User Name</label>
					<input
						type="text"
						id="username"
						required
						ref={userNameInputRef}
					/>
				</div>
				<div>
					<label htmlFor="password">Password</label>
					<input
						type="password"
						id="password"
						required
						ref={passwordInputRef}
					/>
				</div>
				<div>
					<button>Login</button>
				</div>
			</form>
		</section>
	);
}

export default Login;
```

Kemudian akses ke URL : http://localhost:3000/auth/login

Isikan sembarang dulu untuk pengujian, harusnya muncul error
Kemudian isikan user dan password di bawah ini

```bash
user name : admin
Pass : test
```

Harus nya masuk ke Welcom Screen Next Js

Kemudian edit index.js sebagai berikut :

```bash
import { signOut, useSession } from "next-auth/react";
import { useRouter } from "next/dist/client/router";
import Head from "next/head";
import Image from "next/image";
import styles from "../styles/Home.module.css";

export default function Home() {
	const { data: session } = useSession();
	const router = useRouter();

	// untuk melihat session
	console.log("session", session);

	return (
		<div className={styles.container}>
			<Head>
				<title>Create Next App</title>
				<meta
					name="description"
					content="Generated by create next app"
				/>
				<link rel="icon" href="/favicon.ico" />
			</Head>
			<main className={styles.main}>
				{/* Tambahkan Tombol */}
				{session ? (
					<button onClick={() => signOut()}>Log out</button>
				) : (
					<button
						onClick={() => {
							router.push("/auth/login");
						}}
					>
						Sign in
					</button>
				)}
				<h1 className={styles.title}>
					Welcome to <a href="https://nextjs.org">Next.js!</a>
				</h1>

				<p className={styles.description}>
					Get started by editing{" "}
					<code className={styles.code}>pages/index.js</code>
				</p>

				<div className={styles.grid}>
					<a href="https://nextjs.org/docs" className={styles.card}>
						<h2>Documentation &rarr;</h2>
						<p>
							Find in-depth information about Next.js features and
							API.
						</p>
					</a>

					<a href="https://nextjs.org/learn" className={styles.card}>
						<h2>Learn &rarr;</h2>
						<p>
							Learn about Next.js in an interactive course with
							quizzes!
						</p>
					</a>

					<a
						href="https://github.com/vercel/next.js/tree/master/examples"
						className={styles.card}
					>
						<h2>Examples &rarr;</h2>
						<p>
							Discover and deploy boilerplate example Next.js
							projects.
						</p>
					</a>

					<a
						href="https://vercel.com/new?utm_source=create-next-app&utm_medium=default-template&utm_campaign=create-next-app"
						className={styles.card}
					>
						<h2>Deploy &rarr;</h2>
						<p>
							Instantly deploy your Next.js site to a public URL
							with Vercel.
						</p>
					</a>
				</div>
			</main>

			<footer className={styles.footer}>
				<a
					href="https://vercel.com?utm_source=create-next-app&utm_medium=default-template&utm_campaign=create-next-app"
					target="_blank"
					rel="noopener noreferrer"
				>
					Powered by{" "}
					<span className={styles.logo}>
						<Image
							src="/vercel.svg"
							alt="Vercel Logo"
							width={72}
							height={16}
						/>
					</span>
				</a>
			</footer>
		</div>
	);
}
```
